#!/usr/bin/env ruby

require 'fileutils'

APP_ROOT = File.expand_path('..', __dir__)

def log(message)
  puts "[ bin/setup ] #{message}"
end

def system!(*args)
  log "üèÉüèª‚Äç‚ôÇÔ∏è Executing #{args}..."
  system(*args) || abort("\nüö® Command #{args} failed.")
end

FileUtils.chdir APP_ROOT do
  log 'üíé Installing Ruby gems...'
  system('bundle check') || system!('bundle install')

  log 'üì¶ Installing Node.js packages...'
  system! 'bin/yarn check --check-files || bin/yarn install'

  log 'üöß Dropping and recreating the development database...'
  system! 'bin/rails db:reset || bin/rails db:migrate'

  log 'üß™ Dropping and recreating the test database...'
  system!({ 'RAILS_ENV' => 'test' }, 'bin/rails db:reset')

  log "‚ôªÔ∏è  Removing old logs and tempfiles..."
  system! 'bin/rails log:clear tmp:clear'
end
