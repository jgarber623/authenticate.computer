#!/usr/bin/env ruby

require 'fileutils'

APP_ROOT = File.expand_path('..', __dir__)

def log(message)
  puts "[ bin/setup ] #{message}"
end

def system!(*args)
  log "ğŸƒğŸ»â€â™‚ï¸ Executing #{args}..."
  system(*args) || abort("\nğŸš¨ Command #{args} failed.")
end

FileUtils.chdir APP_ROOT do
  log 'ğŸ’ Installing Ruby gems...'
  system('bundle check') || system!('bundle install')

  log 'ğŸ“¦ Installing Node.js packages...'
  system! 'bin/yarn check --check-files || bin/yarn install'

  log 'ğŸš§ Dropping and recreating the development database...'
  system! 'bin/rails db:reset || bin/rails db:migrate'

  log 'ğŸ§ª Dropping and recreating the test database...'
  system!({ 'RAILS_ENV' => 'test' }, 'bin/rails db:reset')

  log 'ğŸ’° Flushing Redis databases...'
  system!('bin/rails redis:reset')

  log 'ğŸ”¥ Removing old logs and tempfiles...'
  system! 'bin/rails log:clear tmp:clear'

  log 'âœ¨ Done!'
end
