#!/usr/bin/env sh

set -e

echo '[ bin/ci ] ğŸ§ª Running test suite...'
bundle exec rspec --format progress --format RspecJunitFormatter --out ./tmp/rspec/results.xml

echo '[ bin/ci ] ğŸ” Analyzing application code for security vulnerabilities...'
bundle exec brakeman --no-pager --run-all-checks --quiet

echo '[ bin/ci ] ğŸ” Analyzing Ruby dependencies for security vulnerabilities...'
bundle exec bundle-audit check --update

# echo '[ bin/ci ] ğŸ” Analyzing Node.js dependencies for security vulnerabilities...'
# yarn audit

set +e

echo "[ bin/ci ] ğŸ” Running code quality checks..."
bundle exec rubocop
rubocop_exit_code=$?

set -e

echo "[ bin/ci ] âœ¨ Done!"

if [[ $rubocop_exit_code -gt 0 ]]; then
  exit 1
fi
