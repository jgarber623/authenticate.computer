#!/usr/bin/env sh

set -e

echo '[ bin/ci ] 🧪 Running test suite...'
bundle exec rspec --format progress --format RspecJunitFormatter --out ./tmp/rspec/results.xml

echo '[ bin/ci ] 🚨 Analyzing application code for security vulnerabilities...'
bundle exec brakeman --no-pager --run-all-checks --quiet

echo '[ bin/ci ] 🚨 Analyzing Ruby dependencies for security vulnerabilities...'
bundle exec bundle audit check --update

set +e

echo "[ bin/ci ] 🔍 Running code quality checks..."
bundle exec rubocop
rubocop_exit_code=$?

set -e

echo "[ bin/ci ] ✨ Done!"

if [[ $rubocop_exit_code -gt 0 ]]; then
  exit 1
fi
